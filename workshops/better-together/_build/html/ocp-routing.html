

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>9. Routing layer &mdash; Better Together: OpenShift and Ansible Workshop Ops Lab Guide 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="10. OpenShift and Ansible integration points" href="integration.html" />
    <link rel="prev" title="8. OpenShift SDN" href="ocp-sdn.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Better Together: OpenShift and Ansible Workshop Ops Lab Guide
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Index</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction and getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="ansible-intro.html">2. Getting to know Ansible</a></li>
<li class="toctree-l1"><a class="reference internal" href="ocp-intro.html">3. OpenShift Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="container-namespaces.html">4. Process isolation with Linux namespaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="container-cgroups.html">5. Quotas and Limits with kernel control groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="container-selinux.html">6. Protection with SELinux</a></li>
<li class="toctree-l1"><a class="reference internal" href="ocp-deploying-apps.html">7. Applications in OpenShift</a></li>
<li class="toctree-l1"><a class="reference internal" href="ocp-sdn.html">8. OpenShift SDN</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">9. Routing layer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#inspecting-haproxy-in-openshift">9.1. Inspecting HAProxy in OpenShift</a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary">9.2. Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="integration.html">10. OpenShift and Ansible integration points</a></li>
<li class="toctree-l1"><a class="reference internal" href="ci-cd.html">11. A real world CI/CD scenario</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary.html">12. Q&amp;A and Wrap-Up</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Better Together: OpenShift and Ansible Workshop Ops Lab Guide</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>9. Routing layer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/ocp-routing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="routing-layer">
<h1>9. Routing layer<a class="headerlink" href="#routing-layer" title="Permalink to this headline">¶</a></h1>
<p>The routing layer integrated with OpenShift uses HAProxy by default. It maps the publicly available route you assign an
application and maps it back to the corresponding pods in your cluster.
Each time an application or route is updated (created, retired, scaled
up or down), the configuration in HAProxy is updated by OpenShift.
HAProxy runs in a pod in the default project on your infrastructure
node.</p>
<div class="section" id="inspecting-haproxy-in-openshift">
<h2>9.1. Inspecting HAProxy in OpenShift<a class="headerlink" href="#inspecting-haproxy-in-openshift" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># oc project default</span>
<span class="c1"># oc get pods</span>
<span class="n">NAME</span>                       <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">docker</span><span class="o">-</span><span class="n">registry</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">77</span><span class="n">rmv</span>    <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">d</span>
<span class="n">registry</span><span class="o">-</span><span class="n">console</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">n7kbk</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">d</span>
<span class="n">router</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">mwb89</span>             <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">d</span> <span class="o">&lt;---</span> <span class="n">router</span> <span class="n">pod</span> <span class="n">running</span> <span class="n">HAProxy</span>
</pre></div>
</div>
<p>If you know the name of a pod, you can us <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">rsh</span></code> to connect to it
remotely. This is doing some fun magic using <code class="docutils literal notranslate"><span class="pre">ssh</span></code> and <code class="docutils literal notranslate"><span class="pre">nsenter</span></code>
under the covers to provide a connection to the proper node inside the
proper namespaces for the pod. Looking in the <code class="docutils literal notranslate"><span class="pre">haproxy.config</span></code> file
for references to <code class="docutils literal notranslate"><span class="pre">app-cli</span></code> gives displays your router configuration
for that application. <code class="docutils literal notranslate"><span class="pre">Ctrl-D</span></code> will exit out of your <code class="docutils literal notranslate"><span class="pre">rsh</span></code> session.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># oc rsh router-1-mwb89
sh-4.2$ grep app-cli haproxy.config
backend be_http:image-uploader:app-cli
server pod:app-cli-1-tthhf:app-cli:10.130.0.36:8080 10.130.0.36:8080 cookie 91b8f12aa1ca5b82e34e730715b58254 weight 256 check inter 5000ms
server pod:app-cli-1-bgt75:app-cli:10.130.0.41:8080 10.130.0.41:8080 cookie 0f411f181edfdfb13c0c0d1b562f5efd weight 256 check inter 5000ms
server pod:app-cli-1-26fgz:app-cli:10.131.0.6:8080 10.131.0.6:8080 cookie 67b4bd5bb54b037c5b37c8acadcfe833 weight 256 check inter 5000ms
</pre></div>
</div>
<p>If you use the <code class="docutils literal notranslate"><span class="pre">oc</span> <span class="pre">get</span> <span class="pre">pods</span></code> command for the Image Uploader project
and limit its output for the app-cli application, you can see the IP
addresses in HAProxy match the pods for the application.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># oc get pods -l app=app-cli -n image-uploader -o wide</span>
<span class="n">NAME</span>              <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>       <span class="n">IP</span>            <span class="n">NODE</span>
<span class="n">app</span><span class="o">-</span><span class="n">cli</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">26</span><span class="n">fgz</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h</span>        <span class="mf">10.131</span><span class="o">.</span><span class="mf">0.6</span>    <span class="n">ip</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">50</span><span class="o">-</span><span class="mf">98.</span><span class="n">ec2</span><span class="o">.</span><span class="n">internal</span>
<span class="n">app</span><span class="o">-</span><span class="n">cli</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">bgt75</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h</span>        <span class="mf">10.130</span><span class="o">.</span><span class="mf">0.41</span>   <span class="n">ip</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">245</span><span class="o">-</span><span class="mf">111.</span><span class="n">ec2</span><span class="o">.</span><span class="n">internal</span>
<span class="n">app</span><span class="o">-</span><span class="n">cli</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">tthhf</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h</span>        <span class="mf">10.130</span><span class="o">.</span><span class="mf">0.36</span>   <span class="n">ip</span><span class="o">-</span><span class="mi">172</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">245</span><span class="o">-</span><span class="mf">111.</span><span class="n">ec2</span><span class="o">.</span><span class="n">internal</span>
</pre></div>
</div>
<p>To confirm HAProxy is automatically updated, let’s scale <code class="docutils literal notranslate"><span class="pre">app-cli</span></code>
back down to 1 pod and re-check the router configuration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># oc scale dc/app-cli -n image-uploader --replicas=1
deploymentconfig.apps.openshift.io &quot;app-cli&quot; scaled

oc get pods -l app=app-cli -n image-uploader -o wide

NAME READY STATUS RESTARTS AGE IP NODE app-cli-1-tthhf 1/1 Running 0 3h
10.130.0.36 ip-172-16-245-111.ec2.internal

oc exec router-1-mwb89 grep app-cli haproxy.config

backend be\_http:image-uploader:app-cli server
pod:app-cli-1-tthhf:app-cli:10.130.0.36:8080 10.130.0.36:8080 cookie
91b8f12aa1ca5b82e34e730715b58254 weight 256 check inter 5000ms \`\`\`

We were able to confirm that our HAProxy configuration updates
automatically when applications are updated.
</pre></div>
</div>
</div>
<div class="section" id="summary">
<h2>9.2. Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>We know this is a mountain of content. Our goal is to present you with
information that will be helpful as you sink your teeth into your own
OpenShift clusters in your own infrastructure. These are some of the
fundamental tools and tricks that are going to be helpful as you begin
this journey.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="integration.html" class="btn btn-neutral float-right" title="10. OpenShift and Ansible integration points" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ocp-sdn.html" class="btn btn-neutral" title="8. OpenShift SDN" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Jamie Duncan

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>